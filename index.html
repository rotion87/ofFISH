<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ÂÅ∑Êá∂È§äÈ≠öÂ∞èÈÅäÊà≤„ÉªÂ§öÈ≠öÁ®ÆÁâà</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- 8-bit Â≠óÈ´î -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #050509;
      color: #f0f0f0;
      font-family: "Press Start 2P", system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      image-rendering: pixelated;
    }
    .game-wrapper {
      width: 320px;
      max-width: 100%;
      border: 4px solid #e0e0e0;
      background: #11131e;
      box-shadow: 0 0 0 2px #222, 0 0 16px rgba(0,0,0,0.7);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 8px;
      gap: 4px;
      cursor: default;
    }
    .stat { white-space: nowrap; }
    .hud button {
      font-family: inherit;
      font-size: 8px;
      padding: 2px 4px;
      background: #22273d;
      border: 2px solid #f0f0f0;
      cursor: pointer;
    }
    .hud button:active { transform: translateY(1px); }

    .hint {
      font-size: 6px;
      opacity: 0.8;
      text-align: right;
    }

    .tank {
      position: relative;
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: linear-gradient(#1c355c 0%, #071427 100%);
      border: 4px solid #9eb5dd;
    }
    .tank::after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .sand {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 24px;
      background: repeating-linear-gradient(
        -45deg,
        #c9a965,
        #c9a965 4px,
        #b48a44 4px,
        #b48a44 8px
      );
    }

    .plant {
      position: absolute;
      bottom: 24px;
      width: 10px;
      height: 60px;
      background: #1e7a4a;
      border-radius: 10px;
      transform-origin: bottom center;
      animation: sway 3s ease-in-out infinite alternate;
      box-shadow: 0 0 0 2px #125035;
    }
    .plant::before,
    .plant::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 16px;
      background: #2bb766;
      border-radius: 8px;
      left: 1px;
    }
    .plant::before { top: 8px; }
    .plant::after { top: 28px; }
    .plant-left { left: 20px; animation-delay: 0s; }
    .plant-right { right: 28px; animation-delay: 1.2s; }

    @keyframes sway {
      0% { transform: rotate(-3deg) scaleY(1); }
      50% { transform: rotate(2deg) scaleY(1.05); }
      100% { transform: rotate(-2deg) scaleY(1); }
    }

    #fishContainer {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .fish {
      position: absolute;
      width: 32px;
      height: 16px;
      border-radius: 16px;
      box-shadow:
        0 0 0 2px var(--outlineColor, #000),
        16px 0 0 0 var(--bodyMid, #ffb55e);
      image-rendering: pixelated;
      background: linear-gradient(to right, var(--bodyFrom, #ffdf6b), var(--bodyTo, #ff9b42));
      animation: swim 6s linear infinite;
      cursor: pointer;
    }
    .fish::before {
      content: "";
      position: absolute;
      right: -10px;
      top: 2px;
      width: 12px;
      height: 12px;
      background: var(--bodyMid, #ffb55e);
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
      box-shadow: 0 0 0 2px var(--outlineColor, #000);
    }
    .fish::after {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 4px;
      height: 4px;
      background: #000;
    }
    .fish.dead {
      filter: grayscale(1) brightness(0.5);
      animation-play-state: paused;
      transform: rotate(90deg) !important;
      top: 150px !important;
      cursor: default;
    }

    .fish-label {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 6px;
      color: #f0f0f0;
      text-shadow: 0 0 2px #000, 0 0 2px #000;
      pointer-events: none;
      white-space: nowrap;
    }

    @keyframes swim {
      0%   { transform: translateX(0) scaleX(1); }
      45%  { transform: translateX(220px) scaleX(1); }
      50%  { transform: translateX(220px) scaleX(-1); }
      95%  { transform: translateX(0) scaleX(-1); }
      100% { transform: translateX(0) scaleX(1); }
    }

    .bubble-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .bubble {
      position: absolute;
      bottom: 10px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      border: 2px solid #9fdfff;
      opacity: 0.9;
      animation: rise 1.4s linear forwards;
    }
    @keyframes rise {
      0% { transform: translateY(0); opacity: 0.9; }
      100% { transform: translateY(-160px); opacity: 0; }
    }

    .message {
      position: absolute;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      font-size: 8px;
      padding: 3px 4px;
      background: rgba(0,0,0,0.55);
      border: 2px solid #f0f0f0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      text-align: center;
      max-width: 95%;
    }
    .message.visible { opacity: 1; }

    .controls {
      display: flex;
      gap: 4px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .controls button {
      flex: 1 1 32%;
      min-width: 0;
      font-family: inherit;
      font-size: 8px;
      padding: 4px 2px;
      border: 2px solid #f0f0f0;
      background: #252a44;
      cursor: pointer;
    }
    .controls button:active { transform: translateY(1px); }

    .save-status {
      font-size: 6px;
      opacity: 0.7;
      text-align: left;
    }

    .hidden { display: none; }

    @media (max-height: 500px) {
      body { align-items: flex-start; }
      .game-wrapper { transform: scale(0.9); transform-origin: top center; }
    }
    @media (max-width: 360px) {
      .game-wrapper { transform: scale(0.9); transform-origin: top center; }
    }

    /* ===== Ëø∑‰Ω†Ë¶ñÁ™óÊ®°ÂºèÔºà?mini=1Ôºâ===== */
    html.mini-mode,
    html.mini-mode body {
      background: transparent;
    }
    html.mini-mode body {
      margin: 0;
      padding: 0;
      justify-content: flex-start;
      align-items: flex-start;
    }
    html.mini-mode .game-wrapper {
      width: 220px;
      border-width: 3px;
      transform: scale(0.9);
      transform-origin: top left;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
      position: fixed;
      top: 20px;
      left: 20px;
    }
    html.mini-mode .hud { cursor: move; }

    html.mini-mode .hint,
    html.mini-mode .save-status,
    html.mini-mode #resetSaveBtn,
    html.mini-mode #restartBtn {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- ÈÅäÊà≤Êú¨È´î -->
  <div class="game-wrapper">
    <div class="hud">
      <div class="stat">Tank LV <span id="level">1</span></div>
      <div class="stat">XP <span id="xp">0</span>/<span id="xpMax">20</span></div>
      <div class="stat">AGE <span id="age">0</span>s</div>
      <button id="muteBtn" title="ÈñãÈóúÈü≥Êïà">üîä</button>
    </div>
    <div class="hint">ÈªûÈ≠öÔºöÊúÉËá™Êàë‰ªãÁ¥π üêü</div>

    <div class="tank">
      <div class="sand"></div>
      <div class="plant plant-left"></div>
      <div class="plant plant-right"></div>

      <div id="fishContainer"></div>
      <div id="bubbleLayer" class="bubble-layer"></div>
      <div id="gameMessage" class="message"></div>
    </div>

    <div class="controls">
      <button id="feedBtn">È§µÈ£ü (+XP)</button>
      <button id="cleanBtn">ÊèõÊ∞¥ (ÈôçÈ¢®Èö™)</button>
      <button id="restartBtn" class="hidden">ÈáçÊñ∞È§ä‰∏ÄÁº∏</button>
      <button id="resetSaveBtn">ÈáçÁΩÆÁ¥ÄÈåÑ</button>
      <button id="miniWindowBtn">Ëø∑‰Ω†Ë¶ñÁ™ó</button>
    </div>
    <div class="save-status" id="saveStatus">Ëá™ÂãïÂ≠òÊ™î‰∏≠‚Ä¶</div>
  </div>

  <script>
    // Ëø∑‰Ω†Ê®°ÂºèÂà§Êñ∑
    const urlParams = new URL(window.location.href).searchParams;
    const isMiniMode = urlParams.get('mini') === '1';
    if (isMiniMode) {
      document.documentElement.classList.add('mini-mode');
    }

    // ÁãÄÊÖã
    let tank = { level: 1, xp: 0, xpMax: 20, age: 0, cleanBuffTicks: 0 };
    const baseDeathChance = 0.002;
    const fishCount = 3;
    let fishList = [];

    // DOM
    const levelEl = document.getElementById("level");
    const xpEl = document.getElementById("xp");
    const xpMaxEl = document.getElementById("xpMax");
    const ageEl = document.getElementById("age");
    const fishContainer = document.getElementById("fishContainer");
    const bubbleLayer = document.getElementById("bubbleLayer");
    const gameMessage = document.getElementById("gameMessage");
    const feedBtn = document.getElementById("feedBtn");
    const cleanBtn = document.getElementById("cleanBtn");
    const restartBtn = document.getElementById("restartBtn");
    const resetSaveBtn = document.getElementById("resetSaveBtn");
    const muteBtn = document.getElementById("muteBtn");
    const saveStatusEl = document.getElementById("saveStatus");
    const gameWrapper = document.querySelector(".game-wrapper");
    const miniWindowBtn = document.getElementById("miniWindowBtn");
    const hudEl = document.querySelector(".hud");

    // Èü≥Êïà
    let audioCtx = null;
    let soundEnabled = true;
    function initAudio() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) audioCtx = new AC();
      }
    }
    function playBubbleSound() {
      if (!soundEnabled) return;
      if (!audioCtx) initAudio();
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const now = audioCtx.currentTime;
      osc.type = "square";
      osc.frequency.setValueAtTime(900, now);
      osc.frequency.exponentialRampToValueAtTime(220, now + 0.2);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 0.25);
    }
    muteBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      muteBtn.textContent = soundEnabled ? "üîä" : "üîà";
      if (soundEnabled && !audioCtx) initAudio();
    });

    // È≠öÁ®Æ
    const speciesList = [
      { name: "Goldy", bodyFrom: "#ffdf6b", bodyTo: "#ff9b42", bodyMid: "#ffb55e", outlineColor: "#b86b26" },
      { name: "Blu",   bodyFrom: "#8fd5ff", bodyTo: "#4b7bff", bodyMid: "#5f9cff", outlineColor: "#2643b8" },
      { name: "Pinky", bodyFrom: "#ffc4df", bodyTo: "#ff6b9f", bodyMid: "#ff8bb8", outlineColor: "#b82662" },
      { name: "Mint",  bodyFrom: "#c7ffd6", bodyTo: "#62e3a9", bodyMid: "#7cf7ba", outlineColor: "#249e60" }
    ];
    const fishNamePool = ["Ê≥°Ê≥°", "Â∞èÂ∞æ", "‰∏∏Â≠ê", "ÈòøÈáë", "ÈòøËóç", "ÈòøÁ≤â", "ÈòøÁ∂†", "Ê≥¢Ê≥¢"];

    function createFishElement(index, species, displayName) {
      const el = document.createElement("div");
      el.className = "fish";
      el.style.setProperty("--bodyFrom", species.bodyFrom);
      el.style.setProperty("--bodyTo", species.bodyTo);
      el.style.setProperty("--bodyMid", species.bodyMid);
      el.style.setProperty("--outlineColor", species.outlineColor);

      const baseTop = 70 + index * 30;
      const randomOffset = (Math.random() - 0.5) * 10;
      el.style.top = (baseTop + randomOffset) + "px";

      const duration = 5 + Math.random() * 3;
      const delay = Math.random() * 3;
      el.style.animationDuration = duration + "s";
      el.style.animationDelay = delay + "s";

      const label = document.createElement("div");
      label.className = "fish-label";
      label.textContent = displayName;
      el.appendChild(label);

      el.dataset.fishIndex = index;
      el.title = displayName;
      fishContainer.appendChild(el);
      return el;
    }

    function initFishFromScratch() {
      fishContainer.innerHTML = "";
      fishList = [];
      for (let i = 0; i < fishCount; i++) {
        const species = speciesList[i % speciesList.length];
        const nameFromPool = fishNamePool[i % fishNamePool.length];
        const displayName = `${species.name}-${nameFromPool}`;
        const el = createFishElement(i, species, displayName);
        const fishObj = { id: i, speciesName: species.name, displayName, alive: true, el };
        fishList.push(fishObj);
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          if (fishObj.alive) {
            showMessage(`„Äå${fishObj.displayName}„ÄçÂú®Ê∞¥Ë£°ÊÇ†ÈÅä‰∏≠ÔΩû`);
          } else {
            showMessage(`„Äå${fishObj.displayName}„ÄçÂ∑≤Á∂ìÁøªËÇö‰∫Ü‚Ä¶`);
          }
        });
      }
    }

    function markFishDead(fishObj) {
      if (!fishObj.alive) return;
      fishObj.alive = false;
      fishObj.el.classList.add("dead");
      fishObj.el.style.animationPlayState = "paused";
      fishObj.el.style.left = fishObj.el.offsetLeft + "px";
    }
    function allFishDead() { return fishList.every(f => !f.alive); }

    // UI
    let msgTimeout = null;
    function updateHUD() {
      levelEl.textContent = tank.level;
      xpEl.textContent = tank.xp;
      xpMaxEl.textContent = tank.xpMax;
      ageEl.textContent = tank.age;
    }
    function showMessage(text, duration = 2500) {
      gameMessage.textContent = text;
      gameMessage.classList.add("visible");
      if (msgTimeout) clearTimeout(msgTimeout);
      msgTimeout = setTimeout(() => gameMessage.classList.remove("visible"), duration);
    }
    function spawnBubble(count = 3) {
      const rect = bubbleLayer.getBoundingClientRect();
      for (let i = 0; i < count; i++) {
        const b = document.createElement("div");
        b.className = "bubble";
        const left = 40 + Math.random() * (rect.width - 80);
        b.style.left = left + "px";
        bubbleLayer.appendChild(b);
        b.addEventListener("animationend", () => b.remove());
      }
    }
    function levelUp() {
      tank.level += 1;
      tank.xp = 0;
      tank.xpMax = Math.round(tank.xpMax * 1.4);
      showMessage(`Áº∏Á≠âÁ¥öÂçáÂà∞ Lv.${tank.level}ÔºÅ`);
    }
    function killRandomFish() {
      const living = fishList.filter(f => f.alive);
      if (!living.length) return;
      const picked = living[Math.floor(Math.random() * living.length)];
      markFishDead(picked);
      showMessage(`„Äå${picked.displayName}„ÄçÁøªËÇö‰∫Ü QQ`, 3500);
      if (allFishDead()) {
        restartBtn.classList.remove("hidden");
        showMessage("ÂÖ®Áº∏Èô£‰∫°‚Ä¶Êåâ„ÄåÈáçÊñ∞È§ä‰∏ÄÁº∏„ÄçÂÜç‰æÜ‰∏ÄÊ¨°„ÄÇ", 4500);
      }
    }
    function resetTank() {
      tank = { level: 1, xp: 0, xpMax: 20, age: 0, cleanBuffTicks: 0 };
      initFishFromScratch();
      restartBtn.classList.add("hidden");
      gameMessage.classList.remove("visible");
      updateHUD();
      saveGame();
    }

    // Â≠òÊ™î
    const SAVE_KEY = "lazyFishGame_v4";
    function saveGame() {
      const data = { tank, fishAlive: fishList.map(f => f.alive) };
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        if (saveStatusEl) saveStatusEl.textContent = "Ëá™ÂãïÂ≠òÊ™î‰∏≠‚Ä¶";
      } catch (e) {
        if (saveStatusEl) saveStatusEl.textContent = "Â≠òÊ™îÂ§±ÊïóÔºàÁ©∫Èñì‰∏çË∂≥ÔºüÔºâ";
      }
    }
    function loadGame() {
      const raw = localStorage.getItem(SAVE_KEY);
      initFishFromScratch();
      if (!raw) { updateHUD(); return; }
      try {
        const data = JSON.parse(raw);
        if (data && data.tank) tank = Object.assign(tank, data.tank);
        if (Array.isArray(data.fishAlive)) {
          data.fishAlive.forEach((alive, idx) => {
            if (fishList[idx] && !alive) markFishDead(fishList[idx]);
          });
        }
        if (allFishDead()) restartBtn.classList.remove("hidden");
        updateHUD();
        if (saveStatusEl) saveStatusEl.textContent = "Â∑≤ËºâÂÖ•‰∏äÊ¨°ÈÄ≤Â∫¶„ÄÇ";
      } catch (e) {
        if (saveStatusEl) saveStatusEl.textContent = "ËÆÄÂèñÂ≠òÊ™îÂ§±ÊïóÔºåÂ∑≤ÈáçÁΩÆÊñ∞Áº∏„ÄÇ";
      }
    }

    // ÊåâÈàï
    feedBtn.addEventListener("click", () => {
      if (allFishDead()) return;
      tank.xp += 5;
      if (tank.xp >= tank.xpMax) levelUp();
      spawnBubble();
      playBubbleSound();
      updateHUD();
      saveGame();
    });
    cleanBtn.addEventListener("click", () => {
      if (allFishDead()) return;
      tank.cleanBuffTicks = 45;
      showMessage("Êèõ‰∫ÜÊñ∞Ê∞¥Ôºå45 ÁßíÂÖßÂÖ®Áº∏ÊØîËºÉ‰∏çÂÆπÊòìÊ≠ª„ÄÇ");
      saveGame();
    });
    restartBtn.addEventListener("click", resetTank);
    resetSaveBtn.addEventListener("click", () => {
      localStorage.removeItem(SAVE_KEY);
      resetTank();
      if (saveStatusEl) saveStatusEl.textContent = "Á¥ÄÈåÑÂ∑≤Ê∏ÖÈô§ÔºåÈáçÊñ∞ÈñãÂßã„ÄÇ";
    });

    // Ëø∑‰Ω†Ë¶ñÁ™óÊåâÈàï
    miniWindowBtn.addEventListener("click", () => {
      const base = window.location.href.split("?")[0];
      const miniUrl = base + "?mini=1";
      window.open(
        miniUrl,
        "lazyFishMini",
        "width=260,height=260,menubar=0,toolbar=0,location=0,status=0"
      );
    });

    // Á¨¨‰∏ÄÊ¨°ÈªûÊìäÂïüÂãï audio
    document.addEventListener("click", function oneClick() {
      if (!audioCtx && soundEnabled) initAudio();
      document.removeEventListener("click", oneClick);
    });

    // Ëø∑‰Ω†Ê®°ÂºèÊãñÊõ≥
    if (isMiniMode) {
      let dragging = false;
      let dragOffsetX = 0;
      let dragOffsetY = 0;
      function onDragMove(e) {
        if (!dragging) return;
        gameWrapper.style.left = (e.clientX - dragOffsetX) + "px";
        gameWrapper.style.top  = (e.clientY - dragOffsetY) + "px";
      }
      function stopDrag() {
        dragging = false;
        document.removeEventListener("mousemove", onDragMove);
        document.removeEventListener("mouseup", stopDrag);
      }
      hudEl.addEventListener("mousedown", (e) => {
        dragging = true;
        const rect = gameWrapper.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        document.addEventListener("mousemove", onDragMove);
        document.addEventListener("mouseup", stopDrag);
      });
    }

    // ‰∏ªËø¥Âúà
    setInterval(() => {
      if (allFishDead()) return;
      tank.age += 1;
      tank.xp += 1;
      if (tank.xp >= tank.xpMax) levelUp();
      let deathChance = baseDeathChance + (tank.level - 1) * 0.0008;
      if (tank.cleanBuffTicks > 0) {
        deathChance *= 0.4;
        tank.cleanBuffTicks -= 1;
      }
      if (Math.random() < deathChance) killRandomFish();
      updateHUD();
      saveGame();
    }, 1000);

    window.addEventListener("beforeunload", saveGame);

    // ÂàùÂßãÂåñ
    loadGame();
  </script>
</body>
</html>
