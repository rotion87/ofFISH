<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>å·æ‡¶é¤Šé­šå°éŠæˆ²ãƒ»å¤šé­šç¨®ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- 8-bit å­—é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 8px;
      background: #050509;
      color: #f0f0f0;
      font-family: "Press Start 2P", system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      image-rendering: pixelated;
    }
    .game-wrapper {
      width: 320px;
      max-width: 100%;
      border: 4px solid #e0e0e0;
      background: #11131e;
      box-shadow: 0 0 0 2px #222, 0 0 16px rgba(0,0,0,0.7);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 8px;
      gap: 4px;
    }
    .stat {
      white-space: nowrap;
    }
    .hud button {
      font-family: inherit;
      font-size: 8px;
      padding: 2px 4px;
      background: #22273d;
      border: 2px solid #f0f0f0;
      cursor: pointer;
    }
    .hud button:active {
      transform: translateY(1px);
    }

    .hint {
      font-size: 6px;
      opacity: 0.8;
      text-align: right;
    }

    .tank {
      position: relative;
      width: 100%;
      height: 200px;
      overflow: hidden;
      background: linear-gradient(#1c355c 0%, #071427 100%);
      border: 4px solid #9eb5dd;
    }
    .tank::after {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 10px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .sand {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 24px;
      background: repeating-linear-gradient(
        -45deg,
        #c9a965,
        #c9a965 4px,
        #b48a44 4px,
        #b48a44 8px
      );
    }

    .plant {
      position: absolute;
      bottom: 24px;
      width: 10px;
      height: 60px;
      background: #1e7a4a;
      border-radius: 10px;
      transform-origin: bottom center;
      animation: sway 3s ease-in-out infinite alternate;
      box-shadow: 0 0 0 2px #125035;
    }
    .plant::before,
    .plant::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 16px;
      background: #2bb766;
      border-radius: 8px;
      left: 1px;
    }
    .plant::before {
      top: 8px;
    }
    .plant::after {
      top: 28px;
    }
    .plant-left {
      left: 20px;
      animation-delay: 0s;
    }
    .plant-right {
      right: 28px;
      animation-delay: 1.2s;
    }
    @keyframes sway {
      0% { transform: rotate(-3deg) scaleY(1); }
      50% { transform: rotate(2deg) scaleY(1.05); }
      100% { transform: rotate(-2deg) scaleY(1); }
    }

    /* é­šå®¹å™¨ */
    #fishContainer {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .fish {
      position: absolute;
      width: 32px;
      height: 16px;
      border-radius: 16px;
      box-shadow:
        0 0 0 2px var(--outlineColor, #000),
        16px 0 0 0 var(--bodyMid, #ffb55e);
      image-rendering: pixelated;
      background: linear-gradient(to right, var(--bodyFrom, #ffdf6b), var(--bodyTo, #ff9b42));
      animation: swim 6s linear infinite;
    }
    .fish::before {
      content: "";
      position: absolute;
      right: -10px;
      top: 2px;
      width: 12px;
      height: 12px;
      background: var(--bodyMid, #ffb55e);
      clip-path: polygon(0 50%, 100% 0, 100% 100%);
      box-shadow: 0 0 0 2px var(--outlineColor, #000);
    }
    .fish::after {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 4px;
      height: 4px;
      background: #000;
    }
    .fish.dead {
      filter: grayscale(1) brightness(0.5);
      animation-play-state: paused;
      transform: rotate(90deg) !important;
      top: 150px !important;
    }

    @keyframes swim {
      0%   { transform: translateX(0) scaleX(1); }
      45%  { transform: translateX(220px) scaleX(1); }
      50%  { transform: translateX(220px) scaleX(-1); }
      95%  { transform: translateX(0) scaleX(-1); }
      100% { transform: translateX(0) scaleX(1); }
    }

    .bubble-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }
    .bubble {
      position: absolute;
      bottom: 10px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      border: 2px solid #9fdfff;
      opacity: 0.9;
      animation: rise 1.4s linear forwards;
    }
    @keyframes rise {
      0% { transform: translateY(0); opacity: 0.9; }
      100% { transform: translateY(-160px); opacity: 0; }
    }

    .message {
      position: absolute;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      font-size: 8px;
      padding: 3px 4px;
      background: rgba(0,0,0,0.55);
      border: 2px solid #f0f0f0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      text-align: center;
      max-width: 95%;
    }
    .message.visible {
      opacity: 1;
    }

    .controls {
      display: flex;
      gap: 4px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .controls button {
      flex: 1 1 32%;
      min-width: 0;
      font-family: inherit;
      font-size: 8px;
      padding: 4px 2px;
      border: 2px solid #f0f0f0;
      background: #252a44;
      cursor: pointer;
    }
    .controls button:active {
      transform: translateY(1px);
    }

    .save-status {
      font-size: 6px;
      opacity: 0.7;
      text-align: left;
    }

    .hidden {
      display: none;
    }

    /* Excel å½è£ç•«é¢ */
    .excel-overlay {
      position: fixed;
      inset: 0;
      background: #ffffff;
      color: #111;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      z-index: 999;
    }
    .excel-titlebar {
      background: #185abd;
      color: #fff;
      padding: 4px 8px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .excel-titlebar span {
      opacity: 0.9;
    }
    .excel-ribbon {
      background: #f3f3f3;
      border-bottom: 1px solid #d0d0d0;
      padding: 4px 8px;
      font-size: 11px;
    }
    .excel-main {
      flex: 1;
      display: flex;
      overflow: auto;
    }
    .excel-sidebar {
      width: 120px;
      border-right: 1px solid #d0d0d0;
      font-size: 11px;
      padding: 4px;
      background: #fafafa;
    }
    .excel-grid-wrapper {
      flex: 1;
      overflow: auto;
    }
    .excel-table {
      border-collapse: collapse;
      font-size: 11px;
      min-width: 600px;
    }
    .excel-table th,
    .excel-table td {
      border: 1px solid #d0d0d0;
      padding: 2px 4px;
      min-width: 60px;
      height: 18px;
    }
    .excel-table th {
      background: #f3f3f3;
      text-align: center;
    }
    .excel-table td {
      text-align: right;
    }
    .excel-table td:first-child {
      text-align: left;
    }

    @media (max-height: 500px) {
      body {
        align-items: flex-start;
      }
      .game-wrapper {
        transform: scale(0.9);
        transform-origin: top center;
      }
    }
    @media (max-width: 360px) {
      .game-wrapper {
        transform: scale(0.9);
        transform-origin: top center;
      }
    }
  </style>
</head>
<body>
  <!-- Excel å½è£ç•«é¢ï¼šæŒ‰ç©ºç™½éµåˆ‡æ› -->
  <div id="excelOverlay" class="excel-overlay hidden">
    <div class="excel-titlebar">
      <span>Budget2025.xlsx - Excel</span>
      <span>ï¹£ â˜ âœ•</span>
    </div>
    <div class="excel-ribbon">
      æª”æ¡ˆ  å¸¸ç”¨  æ’å…¥  ç‰ˆé¢é…ç½®  å…¬å¼  è³‡æ–™  æª¢è¦–
    </div>
    <div class="excel-main">
      <div class="excel-sidebar">
        <strong>æ¨ç´åˆ†æ</strong><br>
        â–¸ å ±è¡¨ä¸€<br>
        â–¸ å ±è¡¨äºŒ<br>
        <br>
        <strong>ç¯©é¸å™¨</strong><br>
        å¹´åº¦ï¼š2025<br>
        æœˆä»½ï¼šå…¨éƒ¨
      </div>
      <div class="excel-grid-wrapper">
        <table class="excel-table">
          <thead>
            <tr>
              <th></th>
              <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th>
            </tr>
          </thead>
          <tbody>
            <tr><th>1</th><td>å“é …</td><td>é ç®—</td><td>å¯¦éš›</td><td>å·®ç•°</td><td>%</td></tr>
            <tr><th>2</th><td>è¡ŒéŠ·è²»ç”¨</td><td>120,000</td><td>115,300</td><td>4,700</td><td>3.9%</td></tr>
            <tr><th>3</th><td>äººäº‹æˆæœ¬</td><td>420,000</td><td>421,800</td><td>-1,800</td><td>-0.4%</td></tr>
            <tr><th>4</th><td>ç§Ÿé‡‘</td><td>180,000</td><td>180,000</td><td>0</td><td>0.0%</td></tr>
            <tr><th>5</th><td>é›œæ”¯</td><td>30,000</td><td>28,450</td><td>1,550</td><td>5.2%</td></tr>
            <tr><th>6</th><td>å°è¨ˆ</td><td>750,000</td><td>745,550</td><td>4,450</td><td>0.6%</td></tr>
            <tr><th>7</th><td></td><td></td><td></td><td></td><td></td></tr>
            <tr><th>8</th><td></td><td></td><td></td><td></td><td></td></tr>
            <tr><th>9</th><td></td><td></td><td></td><td></td><td></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- çœŸæ­£çš„éŠæˆ² -->
  <div class="game-wrapper">
    <div class="hud">
      <div class="stat">Tank LV <span id="level">1</span></div>
      <div class="stat">XP <span id="xp">0</span>/<span id="xpMax">20</span></div>
      <div class="stat">AGE <span id="age">0</span>s</div>
      <button id="muteBtn" title="é–‹é—œéŸ³æ•ˆ">ğŸ”Š</button>
    </div>
    <div class="hint">ç©ºç™½éµï¼šExcel å½è£</div>

    <div class="tank">
      <div class="sand"></div>
      <div class="plant plant-left"></div>
      <div class="plant plant-right"></div>

      <div id="fishContainer"></div>
      <div id="bubbleLayer" class="bubble-layer"></div>
      <div id="gameMessage" class="message"></div>
    </div>

    <div class="controls">
      <button id="feedBtn">é¤µé£Ÿ (+XP)</button>
      <button id="cleanBtn">æ›æ°´ (é™é¢¨éšª)</button>
      <button id="restartBtn" class="hidden">é‡æ–°é¤Šä¸€ç¼¸</button>
      <button id="resetSaveBtn">é‡ç½®ç´€éŒ„</button>
    </div>
    <div class="save-status" id="saveStatus">è‡ªå‹•å­˜æª”ä¸­â€¦</div>
  </div>

  <script>
    // ===== åŸºæœ¬éŠæˆ²ç‹€æ…‹ï¼ˆä»¥æ•´ç¼¸ç‚ºå–®ä½ï¼‰ =====
    let tank = {
      level: 1,
      xp: 0,
      xpMax: 20,
      age: 0,
      cleanBuffTicks: 0
    };

    const baseDeathChance = 0.002; // æ¯ç§’åŸºç¤æ­»äº¡æ©Ÿç‡
    const fishCount = 3;           // ä¸€æ¬¡é¤Š 3 éš»
    let fishList = [];

    // DOM
    const levelEl = document.getElementById("level");
    const xpEl = document.getElementById("xp");
    const xpMaxEl = document.getElementById("xpMax");
    const ageEl = document.getElementById("age");
    const fishContainer = document.getElementById("fishContainer");
    const bubbleLayer = document.getElementById("bubbleLayer");
    const gameMessage = document.getElementById("gameMessage");
    const feedBtn = document.getElementById("feedBtn");
    const cleanBtn = document.getElementById("cleanBtn");
    const restartBtn = document.getElementById("restartBtn");
    const resetSaveBtn = document.getElementById("resetSaveBtn");
    const muteBtn = document.getElementById("muteBtn");
    const saveStatusEl = document.getElementById("saveStatus");
    const excelOverlay = document.getElementById("excelOverlay");
    const gameWrapper = document.querySelector(".game-wrapper");

    // ===== ç°¡å–®éŸ³æ•ˆ =====
    let audioCtx = null;
    let soundEnabled = true;

    function initAudio() {
      if (!audioCtx) {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
          audioCtx = new AudioCtx();
        }
      }
    }

    function playBubbleSound() {
      if (!soundEnabled) return;
      if (!audioCtx) initAudio();
      if (!audioCtx) return;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const now = audioCtx.currentTime;

      osc.type = "square";
      osc.frequency.setValueAtTime(900, now);
      osc.frequency.exponentialRampToValueAtTime(220, now + 0.2);
      gain.gain.setValueAtTime(0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 0.25);
    }

    muteBtn.addEventListener("click", () => {
      soundEnabled = !soundEnabled;
      muteBtn.textContent = soundEnabled ? "ğŸ”Š" : "ğŸ”ˆ";
      if (soundEnabled && !audioCtx) {
        initAudio();
      }
    });

    // ===== é­šç¨®è³‡æ–™ï¼ˆä¸åŒé¡è‰²/å“ç¨®ï¼‰ =====
    const speciesList = [
      {
        name: "Goldy",
        bodyFrom: "#ffdf6b",
        bodyTo: "#ff9b42",
        bodyMid: "#ffb55e",
        outlineColor: "#b86b26"
      },
      {
        name: "Blu",
        bodyFrom: "#8fd5ff",
        bodyTo: "#4b7bff",
        bodyMid: "#5f9cff",
        outlineColor: "#2643b8"
      },
      {
        name: "Pinky",
        bodyFrom: "#ffc4df",
        bodyTo: "#ff6b9f",
        bodyMid: "#ff8bb8",
        outlineColor: "#b82662"
      },
      {
        name: "Mint",
        bodyFrom: "#c7ffd6",
        bodyTo: "#62e3a9",
        bodyMid: "#7cf7ba",
        outlineColor: "#249e60"
      }
    ];

    function createFishElement(index, species) {
      const el = document.createElement("div");
      el.className = "fish";
      el.style.setProperty("--bodyFrom", species.bodyFrom);
      el.style.setProperty("--bodyTo", species.bodyTo);
      el.style.setProperty("--bodyMid", species.bodyMid);
      el.style.setProperty("--outlineColor", species.outlineColor);

      const baseTop = 70 + index * 30;
      const randomOffset = (Math.random() - 0.5) * 10;
      el.style.top = (baseTop + randomOffset) + "px";

      const duration = 5 + Math.random() * 3;
      const delay = Math.random() * 3;
      el.style.animationDuration = duration + "s";
      el.style.animationDelay = delay + "s";

      fishContainer.appendChild(el);
      return el;
    }

    function initFishFromScratch() {
      fishContainer.innerHTML = "";
      fishList = [];
      for (let i = 0; i < fishCount; i++) {
        const species = speciesList[i % speciesList.length];
        const el = createFishElement(i, species);
        fishList.push({
          id: i,
          speciesName: species.name,
          alive: true,
          el
        });
      }
    }

    function markFishDead(fishObj) {
      if (!fishObj.alive) return;
      fishObj.alive = false;
      fishObj.el.classList.add("dead");
      fishObj.el.style.animationPlayState = "paused";
      fishObj.el.style.left = fishObj.el.offsetLeft + "px";
    }

    function allFishDead() {
      return fishList.every(f => !f.alive);
    }

    // ===== UI / è¨Šæ¯ =====
    let msgTimeout = null;

    function updateHUD() {
      levelEl.textContent = tank.level;
      xpEl.textContent = tank.xp;
      xpMaxEl.textContent = tank.xpMax;
      ageEl.textContent = tank.age;
    }

    function showMessage(text, duration = 2500) {
      gameMessage.textContent = text;
      gameMessage.classList.add("visible");
      if (msgTimeout) clearTimeout(msgTimeout);
      msgTimeout = setTimeout(() => {
        gameMessage.classList.remove("visible");
      }, duration);
    }

    function spawnBubble(count = 3) {
      const tankRect = bubbleLayer.getBoundingClientRect();
      for (let i = 0; i < count; i++) {
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        const left = 40 + Math.random() * (tankRect.width - 80);
        bubble.style.left = left + "px";
        bubbleLayer.appendChild(bubble);
        bubble.addEventListener("animationend", () => bubble.remove());
      }
    }

    function levelUp() {
      tank.level += 1;
      tank.xp = 0;
      tank.xpMax = Math.round(tank.xpMax * 1.4);
      showMessage(`ç¼¸ç­‰ç´šå‡åˆ° Lv.${tank.level}ï¼`);
    }

    function killRandomFish() {
      const living = fishList.filter(f => f.alive);
      if (living.length === 0) return;
      const picked = living[Math.floor(Math.random() * living.length)];
      markFishDead(picked);
      showMessage(`ã€Œ${picked.speciesName}ã€ç¿»è‚šäº† QQ`, 3500);

      if (allFishDead()) {
        restartBtn.classList.remove("hidden");
        showMessage("å…¨ç¼¸é™£äº¡â€¦æŒ‰ã€Œé‡æ–°é¤Šä¸€ç¼¸ã€å†ä¾†ä¸€æ¬¡ã€‚", 4500);
      }
    }

    function resetTank() {
      tank = { level: 1, xp: 0, xpMax: 20, age: 0, cleanBuffTicks: 0 };
      initFishFromScratch();
      restartBtn.classList.add("hidden");
      gameMessage.classList.remove("visible");
      updateHUD();
      saveGame();
    }

    // ===== å­˜æª” / è®€å– (localStorage) =====
    const SAVE_KEY = "lazyFishGame_v2";

    function saveGame() {
      const data = {
        tank,
        fishAlive: fishList.map(f => f.alive)
      };
      try {
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        saveStatusEl.textContent = "è‡ªå‹•å­˜æª”ä¸­â€¦";
      } catch (e) {
        saveStatusEl.textContent = "å­˜æª”å¤±æ•—ï¼ˆç©ºé–“ä¸è¶³ï¼Ÿï¼‰";
      }
    }

    function loadGame() {
      const raw = localStorage.getItem(SAVE_KEY);
      initFishFromScratch(); // å…ˆå»ºç«‹ DOM

      if (!raw) {
        updateHUD();
        return;
      }
      try {
        const data = JSON.parse(raw);
        if (data && data.tank) {
          tank = Object.assign(tank, data.tank);
        }
        if (Array.isArray(data.fishAlive)) {
          data.fishAlive.forEach((alive, idx) => {
            if (fishList[idx]) {
              if (!alive) {
                markFishDead(fishList[idx]);
              }
            }
          });
        }
        if (allFishDead()) {
          restartBtn.classList.remove("hidden");
        }
        updateHUD();
        saveStatusEl.textContent = "å·²è¼‰å…¥ä¸Šæ¬¡é€²åº¦ã€‚";
      } catch (e) {
        console.error(e);
        saveStatusEl.textContent = "è®€å–å­˜æª”å¤±æ•—ï¼Œå·²é‡ç½®æ–°ç¼¸ã€‚";
      }
    }

    resetSaveBtn.addEventListener("click", () => {
      localStorage.removeItem(SAVE_KEY);
      resetTank();
      saveStatusEl.textContent = "ç´€éŒ„å·²æ¸…é™¤ï¼Œé‡æ–°é–‹å§‹ã€‚";
    });

    // ===== æ“ä½œäº‹ä»¶ =====
    feedBtn.addEventListener("click", () => {
      if (allFishDead()) return;
      tank.xp += 5;
      if (tank.xp >= tank.xpMax) {
        levelUp();
      }
      spawnBubble();
      playBubbleSound();
      updateHUD();
      saveGame();
    });

    cleanBtn.addEventListener("click", () => {
      if (allFishDead()) return;
      tank.cleanBuffTicks = 45; // ç´„ 45 ç§’
      showMessage("æ›äº†æ–°æ°´ï¼Œ45 ç§’å…§å…¨ç¼¸æ¯”è¼ƒä¸å®¹æ˜“æ­»ã€‚");
      saveGame();
    });

    restartBtn.addEventListener("click", () => {
      resetTank();
    });

    // ç¬¬ä¸€æ¬¡é»æ“Šå•Ÿå‹• audio
    document.addEventListener("click", function oneClick() {
      if (!audioCtx && soundEnabled) {
        initAudio();
      }
      document.removeEventListener("click", oneClick);
    });

    // ===== Excel å½è£ï¼ˆç©ºç™½éµåˆ‡æ›ï¼‰ =====
    let excelVisible = false;
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        excelVisible = !excelVisible;
        if (excelVisible) {
          excelOverlay.classList.remove("hidden");
          gameWrapper.style.display = "none";
        } else {
          excelOverlay.classList.add("hidden");
          gameWrapper.style.display = "flex";
        }
      }
    });

    // ===== ä¸»è¿´åœˆï¼ˆæ¯ç§’ä¸€ tickï¼‰ =====
    setInterval(() => {
      if (allFishDead()) return;

      tank.age += 1;
      tank.xp += 1;
      if (tank.xp >= tank.xpMax) {
        levelUp();
      }

      let deathChance = baseDeathChance + (tank.level - 1) * 0.0008;
      if (tank.cleanBuffTicks > 0) {
        deathChance *= 0.4;
        tank.cleanBuffTicks -= 1;
      }

      if (Math.random() < deathChance) {
        killRandomFish();
      }

      updateHUD();
      saveGame();
    }, 1000);

    // beforeunload å†å­˜ä¸€æ¬¡
    window.addEventListener("beforeunload", saveGame);

    // ===== åˆå§‹åŒ– =====
    loadGame();
  </script>
</body>
</html>
